<!doctype html>
<html>
	<head>
		<script src="https://leeoniya.github.io/uPlot/dist/uPlot.iife.min.js"></script>
		<link rel="stylesheet" href="https://leeoniya.github.io/uPlot/dist/uPlot.min.css">
		<script src="dta0.js"></script>
		<style>
		  html {font-family: Arial, Helvetica, sans-serif; }
			h1 { font-size: 14pt;}
			.toprow:after  {  content: ""; display: table; clear: both; }
			.topblk { float: left; border:solid;padding:4px;margin-bottom:4px;margin-right:4px;font-size:12px;height:180px; }
			#subjsel { font-size:18px; }
			</style>
		<meta charset="utf-8" />
	</head>
	<body>
		<h1>Subject_ID: <select name="subjsel" id="subjsel"><option value="00">00</option></select></h1>
		  <div class="toprow">
				<div class="topblk">
					<video id="v0" tabindex="0", autobuffer preload width="320" height="180" controls>
			        <source type='video/mp4;codecs="avc1.42E01E, mp4a.40.2"' src="s0.mp4"></source>
			    </video>
				</div>
				<div class="topblk">
					Gender: male<br/>Hand: right<br/>Age:≥40<br/>
					Height: 180-189 cm.<br/>Weight: 70-79 kg.
					<hr/>Private Workouts:<br/>Cycling<br/>Frequency: 5
					<hr/>Known Activities: 5,<br/> Regular Activities: 0
				</div>
				<div class="topblk">Session 1<hr/>Duration: 16:33:30<hr/>Activities: 7<hr/>Month: mid-Oct.<br/>morning<hr/> sunny, ≈10◦C<hr/> Location_ID: 1</div>
				<div class="topblk">Session 2<hr/>Duration: 11:55:00<hr/>Activities: 6<hr/>Month: mid-Oct.<br/>afternoon<hr/> partly-cloudy, ≈10◦C<hr/> Location_ID: 1</div>
				<div class="topblk">Session 3<hr/>Duration: 18:06:00<hr/>Activities: 7<hr/>Month: late-Oct.<br/>afternoon<hr/> partly-cloudy, ≈20◦C<hr/> Location_ID: 1</div>
				<div class="topblk">Data Files:<hr/>
					<a href="https://uni-siegen.sciebo.de/s/enHPo7HwP8RccAe/download?path=%2Fraw%2Fcamera&files=sbj_0.mp4">Video [7Gb]</a><br/>
					<a href="https://uni-siegen.sciebo.de/s/enHPo7HwP8RccAe/download?path=%2Fraw%2Finertial%2F50hz&files=sbj_0.csv">IMU sensors [33Mb]</a></div>
				</div>
			</div>
    <script>
		var vid = document.getElementById('v0'), width = window.innerWidth
		const data = [[...Array(raX.length).keys()], raX, raY, raZ, laX, laY, laZ, rlX, rlY, rlZ, llX, llY, llZ ];
		function wheelZoomPlugin(opts) {
			let factor = opts.factor || 0.95;
			return { hooks: {
				ready: u => {
					let rect = u.over.getBoundingClientRect();
					u.over.addEventListener("wheel", e => {  // wheel scroll zoom
						let oxRange = u.scales.x.max - u.scales.x.min;
						let nxRange = e.deltaY < 0 ? oxRange * factor : oxRange / factor;
						let nxMin = u.posToVal(u.cursor.left, "x") - (u.cursor.left/rect.width) * nxRange;
						if (nxMin<0) nxMin = 0;
						let nxMax = nxMin + nxRange;
						if (nxMax>data[0].length) nxMax = data[0].length;
						u.batch(() => { u.setScale("x", { min: nxMin, max: nxMax, });
						});
					}, {passive: true});
				} }
			};
		}
		function bgAnns() {
			function drawBg(u) {
				let { top, height } = u.bbox;
				let { scale } = u.series[0];
				u.ctx.save();
				u.ctx.font = "14px Arial"; u.ctx.textAlign = 'center';
				for (var i=0; i<pos.length-1; i++) {
					if (lbl[i]!='null') {
						startPos = u.valToPos(pos[i], scale, true)
						width = u.valToPos(pos[i+1], scale, true)-startPos
						if (lbl[i].includes('stret')) u.ctx.fillStyle = '#F0FFE0';
						else if (lbl[i].includes('jogg')) u.ctx.fillStyle = '#FFFFE0';
						else if (lbl[i].includes('burp')) u.ctx.fillStyle = '#FFF0F0';
						else if (lbl[i].includes('lung')) u.ctx.fillStyle = '#FFF0FF';
						else u.ctx.fillStyle = '#F0F0FF';
						u.ctx.fillRect(startPos, top, width, height+20);  // left, width for each annotation
						u.ctx.fillStyle = 'black';
						u.ctx.fillText(lbl[i], startPos+width/2, 707)  // annotation
					}
				}
				u.ctx.font = "24px Arial"; u.ctx.textAlign = 'left';
				u.ctx.fillText("right hand", 7, 24); u.ctx.fillText("left hand", 7, 200);
				u.ctx.fillText("right ankle", 7, 380); u.ctx.fillText("left ankle", 7, 560);
				u.ctx.restore();
			}
			return { hooks: { drawClear: drawBg } };  // return hook
		}
    let opts = {
      id: "chart1",
      width: window.innerWidth-9,
      height: 400,
      series: [
        { fill:false, ticks:{show:false}},
        { label:'rax',stroke:'red'},{ label:'ray',stroke:'green'},{ label:'raz',stroke:'blue'},
				{ label:'lax',stroke:'red'},{ label:'lay',stroke:'green'},{ label:'laz',stroke:'blue'},
				{ label:'rlx',stroke:'red'},{ label:'rly',stroke:'green'},{ label:'rlz',stroke:'blue'},
				{ label:'llx',stroke:'red'},{ label:'lly',stroke:'green'},{ label:'llz',stroke:'blue'},
      ],
     	cursor: { bind: {  // capture mouse down
					mousedown: (u, targ, handler) => {
						return e => { vid.currentTime = Math.floor( (vid.duration*e.offsetX) / (u.width-50) ); vid.play()}
						// TODO: get data position !!!
					}, }, y : false, // hide horizontal crosshair
			},
			plugins: [ bgAnns(), wheelZoomPlugin({factor: 0.95})],
      axes: [ {}, { scale: "readings", side: 1, grid: {show: true},}, ],
      scales: { auto: false, "x": { time: false, }, y: { range: { max:160, min:-200,  }} },
      legend: { show: false, },
    };
    let uplot = vid.onseeking = new uPlot(opts, data, document.body);
    // change cursor in uPlot when controlling video:
    vid.ontimeupdate = vid.onplay = vid.onseeking = function() {
			pos = Math.floor((vid.currentTime / vid.duration)*data[0].length)  // this works
			uplot.setCursor({ left: uplot.valToPos(uplot.data[0][pos], 'x'), });
		}
    </script>
		<script>
			var grph = document.getElementById('chart1'); grph.style.border="solid"
		</script>
	</body>
</html>
